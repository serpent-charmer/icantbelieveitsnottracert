<!DOCTYPE html>
<html lang='en'>

<head>
	<title>I woke up one day</title>
	<link rel="icon" href="{{ url_for('static', filename='black_heart.ico') }}">
	<meta charset='utf-8'>
	<style>
		body {
			background-color: #000;
			margin: 0px;
			overflow: hidden;
		}

		#info {
			color: #fff;
			position: absolute;
			bottom: 20px;
			padding: 5px 20px;
			font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
			font-weight: 100;
			font-size: 18px;
			background-color: #000;
		}

		a {
			color: #DDD;
		}
	</style>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
</head>

<body>
	<div id="preModal" class="modal" tabindex="-1" role="dialog">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
		<h5 class="modal-title">Hi!</h5>
		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		  <span aria-hidden="true">&times;</span>
		</button>
	      </div>
	      <div class="modal-body">
		<p>Looks like you're lost!</p>
	      </div>
	      <div class="modal-footer">
		<button type="button" class="btn btn-secondary" onclick="init()" data-dismiss="modal">Click me!</button>
	      </div>
	    </div>
	  </div>
	</div>
	<div id='container'></div>
	<script src='/static/lib/three.min.js'></script>
	<script src='/static/lib/dat.gui.min.js'></script>
	<script src='/static/lib/stats.min.js'></script>
	<script src='/static/lib/postprocessing/EffectComposer.js'></script>
	<script src='/static/lib/postprocessing/RenderPass.js'></script>
	<script src='/static/lib/postprocessing/ShaderPass.js'></script>
	<script src='/static/lib/postprocessing/MaskPass.js'></script>
	<script src='/static/lib/shaders/CopyShader.js'></script>
	<script src='/static/lib/shaders/FilmShader.js'></script>
	<script src='/static/lib/shaders/RGBShiftShader.js'></script>
	<script src='/static/js/BadTVShader.js'></script>
	<script src='/static/js/StaticShader.js'></script>

	<script>


		Array.prototype.sample = function(){
			  return this[Math.floor(Math.random()*this.length)];
			}

		var camera, scene, renderer;
		var video, videoTexture, videoMaterial;
		var composer;
		var shaderTime = 0;
		var badTVParams, badTVPass;
		var staticParams, staticPass;
		var rgbParams, rgbPass;
		var filmParams, filmPass;
		var renderPass, copyPass;
		var gui;
		var pnoise, globalParams;
		
		$('#preModal').modal('show');
		
		

		function init() {

			//Load Video
			video = document.createElement('video');
			video.crossOrigin ="anonymous";
			video.loop = false;
			video.muted = false;
			video.src = '/static/res/' + ['LornVisualised.webm', 'roygbiv.webm', 'WormsAccordionWebm.webm'].sample();
			
			video.play();
			

			//init video texture
			videoTexture = new THREE.Texture(video);
			videoTexture.minFilter = THREE.LinearFilter;
			videoTexture.magFilter = THREE.LinearFilter;
			videoMaterial = new THREE.MeshBasicMaterial({
				map: videoTexture
			});

			//init camera
			camera = new THREE.PerspectiveCamera(55, 1080 / 720, 20, 3000);
			camera.position.z = 1000;
			scene = new THREE.Scene();

			//Add video plane
			var planeGeometry = new THREE.PlaneGeometry(1080, 720, 1, 1);
			var plane = new THREE.Mesh(planeGeometry, videoMaterial);
			scene.add(plane);
			plane.z = 0;
			plane.scale.x = plane.scale.y = 1.45;

			//add stats
			/*
			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			container.appendChild(stats.domElement);
			*/
			//init renderer
			renderer = new THREE.WebGLRenderer();
			renderer.setSize(800, 600);
			document.body.appendChild(renderer.domElement);

			//POST PROCESSING
			//Create Shader Passes
			renderPass = new THREE.RenderPass(scene, camera);
			badTVPass = new THREE.ShaderPass(THREE.BadTVShader);
			rgbPass = new THREE.ShaderPass(THREE.RGBShiftShader);
			filmPass = new THREE.ShaderPass(THREE.FilmShader);
			staticPass = new THREE.ShaderPass(THREE.StaticShader);
			copyPass = new THREE.ShaderPass(THREE.CopyShader);

			//set shader uniforms
			filmPass.uniforms.grayscale.value = 0;

			//Init DAT GUI control panel
			badTVParams = {
				mute: false,
				show: true,
				distortion: 0.005,
				distortion2: 0.005,
				speed: 0.3,
				rollSpeed: 0.01
			};

			staticParams = {
				show: true,
				amount: 0.1,
				size: 1.0
			};

			rgbParams = {
				show: true,
				amount: 0.0,
				angle: 0.3,
			};

			filmParams = {
				show: true,
				count: 800,
				sIntensity: 0.9,
				nIntensity: 0.4
			};
			/*
			gui = new dat.GUI();

			gui.add(badTVParams, 'mute').onChange(onToggleMute);

			var f1 = gui.addFolder('Bad TV');
			f1.add(badTVParams, 'show').onChange(onToggleShaders);
			f1.add(badTVParams, 'distortion', 0.1, 20).step(0.1).listen().name('Thick Distort').onChange(onParamsChange);
			f1.add(badTVParams, 'distortion2', 0.1, 20).step(0.1).listen().name('Fine Distort').onChange(onParamsChange);
			f1.add(badTVParams, 'speed', 0.0, 1.0).step(0.01).listen().name('Distort Speed').onChange(onParamsChange);
			f1.add(badTVParams, 'rollSpeed', 0.0, 1.0).step(0.01).listen().name('Roll Speed').onChange(onParamsChange);
			f1.open();

			var f2 = gui.addFolder('RGB Shift');
			f2.add(rgbParams, 'show').onChange(onToggleShaders);
			f2.add(rgbParams, 'amount', 0.0, 0.1).listen().onChange(onParamsChange);
			f2.add(rgbParams, 'angle', 0.0, 2.0).listen().onChange(onParamsChange);
			f2.open();

			var f4 = gui.addFolder('Static');
			f4.add(staticParams, 'show').onChange(onToggleShaders);
			f4.add(staticParams, 'amount', 0.0, 1.0).step(0.01).listen().onChange(onParamsChange);
			f4.add(staticParams, 'size', 1.0, 100.0).step(1.0).onChange(onParamsChange);
			f4.open();

			var f3 = gui.addFolder('Scanlines');
			f3.add(filmParams, 'show').onChange(onToggleShaders);
			f3.add(filmParams, 'count', 50, 1000).onChange(onParamsChange);
			f3.add(filmParams, 'sIntensity', 0.0, 2.0).step(0.1).onChange(onParamsChange);
			f3.add(filmParams, 'nIntensity', 0.0, 2.0).step(0.1).onChange(onParamsChange);
			f3.open();

			gui.close();
			*/

			onToggleShaders();
			onToggleMute();
			onParamsChange();

			window.addEventListener('resize', onResize, false);
			renderer.domElement.addEventListener('click', randomizeParams, false);
			onResize();
			//randomizeParams();
			
			animate();
		}

		function onParamsChange() {

			//copy gui params into shader uniforms
			badTVPass.uniforms['distortion'].value = badTVParams.distortion;
			badTVPass.uniforms['distortion2'].value = badTVParams.distortion2;
			badTVPass.uniforms['speed'].value = badTVParams.speed;
			badTVPass.uniforms['rollSpeed'].value = badTVParams.rollSpeed;

			staticPass.uniforms['amount'].value = staticParams.amount;
			staticPass.uniforms['size'].value = staticParams.size;

			rgbPass.uniforms['angle'].value = rgbParams.angle * Math.PI;
			rgbPass.uniforms['amount'].value = rgbParams.amount;

			filmPass.uniforms['sCount'].value = filmParams.count;
			filmPass.uniforms['sIntensity'].value = filmParams.sIntensity;
			filmPass.uniforms['nIntensity'].value = filmParams.nIntensity;
		}


		function randomizeParams() {

			badTVParams.distortion = Math.random() * 6;
			badTVParams.distortion2 = Math.random() * 6;
			badTVParams.speed = Math.random() * 0.4;
			badTVParams.rollSpeed = Math.random() * 0.2;
			rgbParams.angle = Math.random() * 2;
			rgbParams.amount = Math.random() * 0.02;
			staticParams.amount = Math.random() * 0.2;

			onParamsChange();
			
			video.play();
		}

		function onToggleMute() {
			video.muted = badTVParams.mute;
		}

		function onToggleShaders() {

			//Add Shader Passes to Composer
			//order is important 
			composer = new THREE.EffectComposer(renderer);
			composer.addPass(renderPass);

			if (filmParams.show) {
				composer.addPass(filmPass);
			}

			if (badTVParams.show) {
				composer.addPass(badTVPass);
			}

			if (rgbParams.show) {
				composer.addPass(rgbPass);
			}

			if (staticParams.show) {
				composer.addPass(staticPass);
			}

			composer.addPass(copyPass);
			copyPass.renderToScreen = true;
		}

		function animate() {

			shaderTime += 0.1;
			badTVPass.uniforms['time'].value = shaderTime;
			filmPass.uniforms['time'].value = shaderTime;
			staticPass.uniforms['time'].value = shaderTime;

			if (video.readyState === video.HAVE_ENOUGH_DATA) {
				if (videoTexture) videoTexture.needsUpdate = true;
			}

			requestAnimationFrame(animate);
			composer.render(0.1);
			//stats.update();
		}

		function onResize() {
			renderer.setSize(window.innerWidth, window.innerHeight);
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
		}

	</script>
</body>

</html>